<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowCommerce - Supabase Migration Tool</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff; 
      padding: 2rem;
      min-height: 100vh;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #8b5cf6; margin-bottom: 0.5rem; }
    .subtitle { color: #888; margin-bottom: 2rem; }
    .card {
      background: rgba(22, 33, 62, 0.8);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .step { 
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      padding: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .step:last-child { border-bottom: none; }
    .step-num {
      width: 36px;
      height: 36px;
      background: #4a4a6a;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .step.running .step-num { background: #f59e0b; animation: pulse 1s infinite; }
    .step.done .step-num { background: #10b981; }
    .step.error .step-num { background: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .step-content { flex: 1; }
    .step-title { font-weight: 600; margin-bottom: 0.25rem; }
    .status { color: #888; font-size: 0.85rem; }
    .step.done .status { color: #10b981; }
    .step.error .status { color: #ef4444; }
    .step.running .status { color: #f59e0b; }
    button {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }
    button:disabled { background: #4a4a6a; cursor: not-allowed; transform: none; box-shadow: none; }
    .log {
      background: #0a0a1a;
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      font-size: 0.8rem;
    }
    .log-entry { padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-entry.success { color: #10b981; }
    .log-entry.error { color: #ef4444; }
    .log-entry.info { color: #60a5fa; }
    .log-entry.warn { color: #f59e0b; }
    .warning { 
      background: rgba(139, 92, 246, 0.1); 
      border: 1px solid rgba(139, 92, 246, 0.3); 
      padding: 1rem; 
      border-radius: 8px; 
      margin-bottom: 1rem;
    }
    .warning h3 { color: #f59e0b; margin-bottom: 0.5rem; }
    pre {
      background: #0a0a1a;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.75rem;
      margin-top: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat-card {
      background: rgba(139, 92, 246, 0.1);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-value { font-size: 2rem; font-weight: bold; color: #8b5cf6; }
    .stat-label { color: #888; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ FlowCommerce Migration Tool</h1>
    <p class="subtitle">Migrate product data from DummyJSON API to your Supabase database</p>

    <div class="warning">
      <h3>‚ö†Ô∏è Before running migration:</h3>
      <p>Make sure you've created the tables in your Supabase SQL Editor. Copy and run the contents of <strong>supabase-schema.sql</strong></p>
      <pre>-- Quick summary of tables needed:
CREATE TABLE categories (id SERIAL PRIMARY KEY, name VARCHAR(100) UNIQUE, slug VARCHAR(100), product_count INTEGER DEFAULT 0);
CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255), description TEXT, price DECIMAL, category VARCHAR(100), stock INTEGER, image VARCHAR(500), rating DECIMAL, brand VARCHAR(100));
-- See supabase-schema.sql for full schema with RLS policies</pre>
    </div>

    <div class="card">
      <div class="step pending" id="step1">
        <div class="step-num">1</div>
        <div class="step-content">
          <div class="step-title">Fetch Products from API</div>
          <div class="status">Waiting to start...</div>
        </div>
      </div>
      <div class="step pending" id="step2">
        <div class="step-num">2</div>
        <div class="step-content">
          <div class="step-title">Extract Categories</div>
          <div class="status">Waiting...</div>
        </div>
      </div>
      <div class="step pending" id="step3">
        <div class="step-num">3</div>
        <div class="step-content">
          <div class="step-title">Upload Categories to Supabase</div>
          <div class="status">Waiting...</div>
        </div>
      </div>
      <div class="step pending" id="step4">
        <div class="step-num">4</div>
        <div class="step-content">
          <div class="step-title">Upload Products to Supabase</div>
          <div class="status">Waiting...</div>
        </div>
      </div>
      <div class="step pending" id="step5">
        <div class="step-num">5</div>
        <div class="step-content">
          <div class="step-title">Verify & Complete</div>
          <div class="status">Waiting...</div>
        </div>
      </div>
    </div>

    <button id="startBtn" onclick="startMigration()">üöÄ Start Migration</button>

    <div class="log" id="log"></div>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="statProducts">0</div>
        <div class="stat-label">Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statCategories">0</div>
        <div class="stat-label">Categories</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statTime">0s</div>
        <div class="stat-label">Duration</div>
      </div>
    </div>
  </div>

  <script>
    // Supabase Config
    const SUPABASE_URL = 'https://iyddgoxxvygfavgoxzrf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGRnb3h4dnlnZmF2Z294enJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MjQ5MjksImV4cCI6MjA4NjAwMDkyOX0.a9RYYOLJ9MdFeZGSXDmu6zgIcsELJZ-fXWVDOZ2mMEs';

    let products = [];
    let categories = [];
    const startTime = Date.now();

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStep(stepId, status, message) {
      const step = document.getElementById(stepId);
      step.className = `step ${status}`;
      step.querySelector('.status').textContent = message;
    }

    async function supabaseRequest(endpoint, options = {}) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        method: options.method || 'GET',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': options.prefer || 'return=representation',
          ...options.headers
        },
        body: options.body ? JSON.stringify(options.body) : undefined
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error);
      }

      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }

    async function startMigration() {
      const btn = document.getElementById('startBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Migrating...';
      const migrationStart = Date.now();

      try {
        // ============================================
        // STEP 1: Fetch Products from DummyJSON API
        // ============================================
        updateStep('step1', 'running', 'Fetching products from API...');
        log('Connecting to DummyJSON API...');
        
        const response = await fetch('https://dummyjson.com/products?limit=0');
        if (!response.ok) throw new Error('Failed to fetch from DummyJSON API');
        
        const data = await response.json();
        products = data.products;
        
        log(`‚úì Fetched ${products.length} products from DummyJSON API`, 'success');
        updateStep('step1', 'done', `Fetched ${products.length} products`);

        // ============================================
        // STEP 2: Extract Categories
        // ============================================
        updateStep('step2', 'running', 'Extracting categories...');
        log('Extracting unique categories from products...');
        
        const categoryMap = {};
        products.forEach(p => {
          const cat = p.category;
          if (!categoryMap[cat]) {
            categoryMap[cat] = { 
              name: cat, 
              slug: cat.toLowerCase().replace(/\s+/g, '-'),
              product_count: 0 
            };
          }
          categoryMap[cat].product_count++;
        });
        
        categories = Object.values(categoryMap);
        log(`‚úì Found ${categories.length} unique categories`, 'success');
        updateStep('step2', 'done', `Extracted ${categories.length} categories`);

        // ============================================
        // STEP 3: Upload Categories to Supabase
        // ============================================
        updateStep('step3', 'running', 'Uploading categories...');
        log('Clearing existing categories in Supabase...');
        
        try {
          await supabaseRequest('categories?id=gt.0', { method: 'DELETE', prefer: 'return=minimal' });
          log('Existing categories cleared', 'info');
        } catch (e) {
          log('Note: Could not clear categories (table may be empty)', 'warn');
        }

        log('Uploading categories to Supabase...');
        await supabaseRequest('categories', {
          method: 'POST',
          body: categories,
          prefer: 'return=minimal'
        });
        
        log(`‚úì Uploaded ${categories.length} categories to Supabase`, 'success');
        updateStep('step3', 'done', `Uploaded ${categories.length} categories`);

        // ============================================
        // STEP 4: Upload Products to Supabase
        // ============================================
        updateStep('step4', 'running', 'Uploading products...');
        log('Clearing existing products in Supabase...');
        
        try {
          await supabaseRequest('products?id=gt.0', { method: 'DELETE', prefer: 'return=minimal' });
          log('Existing products cleared', 'info');
        } catch (e) {
          log('Note: Could not clear products (table may be empty)', 'warn');
        }

        // Transform products for Supabase
        const transformedProducts = products.map(p => ({
          id: p.id,
          name: p.title,
          description: p.description,
          price: Math.round(p.price * 83), // Convert USD to INR
          original_price: p.discountPercentage > 0 ? Math.round((p.price / (1 - p.discountPercentage / 100)) * 83) : null,
          category: p.category,
          stock: p.stock || 50,
          image: p.thumbnail,
          rating: p.rating,
          discount_percentage: p.discountPercentage || 0,
          brand: p.brand || 'Generic',
          sku: p.sku || `SKU-${p.id}`,
          status: p.stock > 0 ? 'active' : 'out_of_stock'
        }));

        // Upload in batches
        const batchSize = 50;
        let uploaded = 0;
        
        for (let i = 0; i < transformedProducts.length; i += batchSize) {
          const batch = transformedProducts.slice(i, i + batchSize);
          
          await supabaseRequest('products', {
            method: 'POST',
            body: batch,
            prefer: 'return=minimal'
          });
          
          uploaded += batch.length;
          log(`Uploaded products: ${uploaded}/${transformedProducts.length}`, 'info');
          updateStep('step4', 'running', `Uploading... ${uploaded}/${transformedProducts.length}`);
        }

        log(`‚úì Uploaded ${uploaded} products to Supabase`, 'success');
        updateStep('step4', 'done', `Uploaded ${uploaded} products`);

        // ============================================
        // STEP 5: Verify & Complete
        // ============================================
        updateStep('step5', 'running', 'Verifying data...');
        log('Verifying data in Supabase...');

        const verifyProducts = await supabaseRequest('products?select=id');
        const verifyCategories = await supabaseRequest('categories?select=id');
        
        const productCount = verifyProducts?.length || 0;
        const categoryCount = verifyCategories?.length || 0;
        const duration = ((Date.now() - migrationStart) / 1000).toFixed(1);
        
        log(`‚úì Verified: ${productCount} products, ${categoryCount} categories`, 'success');
        updateStep('step5', 'done', `Complete! ${productCount} products, ${categoryCount} categories`);

        // Show stats
        document.getElementById('stats').style.display = 'grid';
        document.getElementById('statProducts').textContent = productCount;
        document.getElementById('statCategories').textContent = categoryCount;
        document.getElementById('statTime').textContent = `${duration}s`;

        log('üéâ Migration complete! Your Supabase database is ready.', 'success');
        log('You can now close this page and refresh your FlowCommerce app.', 'success');
        
        btn.textContent = '‚úÖ Migration Complete!';
        btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';

      } catch (error) {
        log(`‚úó Error: ${error.message}`, 'error');
        console.error(error);
        btn.textContent = '‚ùå Migration Failed - Check Console';
        btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        
        document.querySelectorAll('.step.running').forEach(step => {
          step.className = 'step error';
          step.querySelector('.status').textContent = 'Failed - ' + error.message.substring(0, 50);
        });
      }
    }
  </script>
</body>
</html>
